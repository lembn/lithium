# lithium

`lithium` is a battery capacity optimiser for drone builds that uses machine learning techniques to find the optimum battery capacity for a drone.

---

base mass: 535

6000mAh @ 424g -> 23.4min
https://www.amazon.co.uk/HRB-6000mAh-Replacement-Airplane-Helicopter/dp/B0856XQFCV/ref=sr_1_8?keywords=3S+Lipo&qid=1641754353&sr=8-8
7100mAh @ 428g -> 27.7min
https://www.amazon.co.uk/SUNPADOW-Battery-7100mAh-Connector-Racing/dp/B08R9Q2PPW/ref=sr_1_9?keywords=3S+Lipo&qid=1641754353&sr=8-9
8000mAh @ 493g -> 31.2min
https://www.amazon.co.uk/Zeee-8000mAh-Rechargeable-Battery-Associated/dp/B07JZ3S457/ref=sr_1_27?keywords=3S+Lipo&qid=1641754353&sr=8-27

---

## flight time calculation

> _This formula is designed to observe how different batteries affect the total flight time of a drone. Because of this, it is assumed that the capacity and voltage of the battery is known. Likewise, the formula assumes that the following information is already known about the motor:_
>
> - _Maximum current draw under load_
> - _Maximum power conusmption under load_

Battery capacity is measured in amp-hours, where a 2Ah battery can power a system drawing 2A for 1 hour, or a system drawing 1A for 30 min, and so on. As you can see, the relationship between capacity and usage time is a division, where the usage time (in hours) is equal to the capacity divided by the current draw. Applying this formula to drones. we can say:

$$t = \frac{c}{\text{ACD}}$$

> _Where:_
>
> - $t$ _is time (**hours**)_
> - $\text{ACD}$ _is Average Current Draw (**A**)_
> - $c$ _is the capacity of the battery (**Ah**)_

However, for safety reasons, LiPo batteries should never be discharged below 80%, which reduces our usable capacity. This percentage can be tweaked depending on how much risk you're willing to take with your battery (but you really shouldn't), so we'll add it into the equation:

$$t = \frac{c \cdot D}{\text{ACD}}$$

> _Where $D$ is discharge **percentage in decimal form**._

Next, we have to calculate average current draw. $\text{ACD}$ consists of a varaible part $I_v$, and a constant part, $I_c$. For the constant part, $I_c$, we simply take a sum of the current draw of all components that will consistently draw the same current, regardless of the amount of thrust being applied.

The variable part, $I_v$ represents the current drawn by the motors. This which will change depending on how much thrust is being applied which is why we take an _average_ for these calculations. To find a value for the average current drawn by a single motor, $I$, we use the equation for electrcal power:

$$I \cdot V = P$$
$$I = \frac{P}{V}$$

> _Where:_
>
> - $P$ _is power consumption of the motor under (**W**)_
> - $V$ _is the voltage being applied to the motor (**V**)_

Considering we already know $V$, we have two ways to find $I$. Either find $P$ and solve the equation for $I$, or ingore the equation and find $I$ from some other current draw value.

Since we are looking for _average_ current draw, we'll take $P$ to be the _average_ power consumption of one motor over the entire flight. This can easily be found by taking some percentage of the maximum power consumption, $P_{MAX}$, assuming that $P$ will be around that percentage of $P_{MAX}$ over the course of the flight. We'll call this ratio _"Flight Intensity", $F$_ - which will be a percentage in decimal form. Using this we find:

$$P = F \cdot P_{MAX}$$
$$I_1 = \frac{P}{V}$$
$$I_1 = \frac{F \cdot P_{MAX}}{V}$$

For our second method, ignoring the equation, we can find $I$ by taking a percentage of the maximum current draw, $I_{MAX}$ of the motors. This percentage will be our _Flight Intensity_ from last time, on the same assumption that over the course of the whole flight, the average current draw, $I_2$ will be $F \cdot I_{MAX}$.

To find $I_v$, we multiply both of our expressions for $I$ by the number of motors, $N$, and now we can create expressions for $\text{ACD}$:

$$\text{ACD} = I_c + I_v$$
$$\text{ACD} = I_c + N \cdot I_1 = I_c + \frac{N \cdot F \cdot P_{MAX}}{V}$$
$$\text{ACD} = I_c + N \cdot I_2 = I_c + N \cdot F \cdot I_{MAX}$$

This means we have two forms of our flight time equation.

$\text{Power Consumption Form:}$
$$t_1 = \frac{c \cdot D}{I_c + \frac{N \cdot F \cdot P_{MAX}}{V}}$$

$\text{Current Draw Form:}$
$$t_2 = \frac{c \cdot D}{I_c + N \cdot F \cdot I_{MAX}}$$

Finally, we need to find $F$ - the Flight Intensity. For many drones, the majority of the flight is spent hovering, or moving parallel to plane of the surface of the earth - so a good baseline for $F$ is the amount of force required to hover. For the drone to hover, the motors need to generate enough thrust to balance the weight of the drone. The total weight of the drone is $m \cdot G$, where $m$ is the total mass of the drone and $G$ is the gravitational feild strength.

The maximum total thrust generated by all motors on the drone is $N \cdot T$ where $T$ is the maximal thrust generated by a single motor. To hover, total thrust needs to be equal to total weight, so the percentage of thrust required to hover is:

$$F = \frac{\frac{m \cdot G}{N}}{T} = \frac{m \cdot G}{N \cdot T}$$

Unfortunately, it won't be that simple. Motor manufacturers rarely state the actual thrust (in newtons) generated by the motor, instead opting to write "thrust tables", which tell consumers the *"pull"* generated by a motor, normally ***in grams*** (this is NOT thrust). Pull is measured by spinning the motor at full thrust against a scale, and measuring the read-out given by the scale. This read-out is the mass component of the force (thrust) being generated by the motor, so to get back to the force, we multiply the mass by it's acceleration ($F = ma$). The thrust's acceleration is the negative of the gravitational field strength, since the drone is a free-falling object subject to gravity, and the motors are acting against gravity. Now that we know $T = pG$ (where $p$ is the pull value), we have:

$$F = \frac{m \cdot G}{N \cdot p \cdot G} = \frac{m}{N \cdot p}$$

As you can see, the substitution of $pG$ for $T$ simplified our expression, as the $G$s in the fraction cancelled each other out. This is why manufacturers perfer to supply pull values rather than thrust: it makes calculations that use weight against thrust much simpler.

As mentioned earlier, this expression for $F$ is only a baseline, different builds may run at different average thrusts and the expression for $F$ needs to be able to account for this. To do this, we'll introduce a value, $b$ to act as a bias and add it to our current expression for $F$. The desired effect of the bias is to offset the resultant value in a particular direction by some magnitude. Since $F$ isrepresents a percentage, we'll also introduce a clipped linear function, $f$ to ensure that our values never go above 1 or below 0.

$$
\text{let } clip(x) =
	\begin{cases}
		0, \quad x \leq 0 \\
		x, \quad 0 < x < 1 \\
		1, \quad 1 \leq x
	\end{cases}
$$

$$F = clip(\frac{m}{N \cdot p} + 0.001b)$$

As you can see, the introduction of $b$ makes $F$ more adaptable, allowing the value to be offset, but also allowing remain $F$ to remain general if $b = 0$. The multiplier applied to $b$ is there to soften the effect that the bias value has on the value of $F$.

Another thing to notice here is that $F$ contains $N$ in it's denominator, and in both of our forms for $T$, we multiply $F$ by $N$. Because of this, $N$ cancels out and we can remove it from our equations entirely. Now we have the forms for $t$ with $F$:

> $\text{Power Consumption Form:}$ $$t_1 = \frac{c \cdot D}{I_c + \frac{F \cdot P_{MAX}}{V}}$$
>
> $\text{Current Draw Form:}$ $$t_2 = \frac{c \cdot D}{I_c + F \cdot I_{MAX}}$$
>
> $\text{Where}$
> $$ clip(x) = \begin{cases} 0, \quad x \leq 0 \\ x, \quad 0 < x < 1 \\ 1, \quad 1 \leq x \end{cases}$$
> $$F = clip(\frac{m}{p} + 0.001b)$$

Each of these forms is very simple, since we achieved our orignal goal of dividing the total usable capacity of the battery by some estimated average current draw.

In theory, $t_1$ and $t_2$ will be equal, since even though the expressions are different, they'ds both using some method to find the variable part of $\text{ACD}$. $t_1$ is the theoretical value (derived from the equation for electrical power), while $t_2$ is the practical value reported by the manufacturer. We will take $t$ to be the mean average between $t_1$ and $t_2$:

> $$ clip(x) = \begin{cases} 0, \quad x \leq 0 \\ x, \quad 0 < x < 1 \\ 1, \quad 1 \leq x \end{cases}$$
> $$F = clip(\frac{m}{p} + 0.001b)$$
> $$t = \frac{\frac{c \cdot D}{I_c + \frac{F \cdot P_{MAX}}{V}} + \frac{c \cdot D}{I_c + F \cdot I_{MAX}}}{2}$$

> _Where:_
>
> - $m$ _is the total mass of the drone (**kg**)._
> - $p$ _is the pull produced by a single motor (**kg**)._
> - $b$ _is the **Flight Intensity bias**._
> - $t$ _is flight time (**hours**)._
> - $c$ _is the capacity of the battery (**Ah**)._
> - $D$ _is discharge **percentage in decimal form**._
> - $I_c$ _constant current draw (**A**)._
> - $P_{MAX}$ _is the maximum power consumption of a single motor (**W**)_
> - $V$ _is the voltage of the battery (**V**)._
> - $I_{MAX}$ _is the maximum current drawn by a single motor (**A**)_

## The Function
<iframe src="https://www.desmos.com/calculator/uii8rmxzki?embed" width="500" height="500" style="border: 1px solid #ccc" frameborder=0></iframe>

[This](https://www.desmos.com/calculator/ivuhbxfa4n) is the estimation for the CEDRIC drone's battery life model. The model was obtained by estimating the relationship between battery mass and battery capacity, which resulted in a gradient which could be used for expressing mass in terms of capaicty, meaning there is only one unknown variable in the expression for $t$. It is worth noting that the estimated gradient is linear but the degree of the actual realtionship between mass and capacity is unknown, so extrapolating masses from capacities outside of the original dataset used for the estimation may yield innacurate results. 

The resulting graph shows that all models with this formula have no theoretical maximum, so there is no *best* battery. It also shows that the model can be influenced by tuning different parameters of the drone:

$bias$ increases and decreases the flight time as expected, and the $0.01$ multiplier has the desired effect of lightening the effect of the change in bias on the overall flight time.

$D$ (discharge) obviously increases the flight time as the discharge capacity is increased, as there is a greater capacity available to use.

Increasing $I_c$ decreases flight time (also as expected).

The $p$ value of the motors has a major impact on the overall flight time, since it directly affects the result of the flight intensity calculation which has a large impact on the formula.

Reducing the $P_{MAX}$ value of the motor, also has a large benefit to the result of the calculation - since a lower $P_{MAX}$ with the same $p$ value means the motor is more power efficient, drawing less power.

As the voltage $V$ of the battery increases, the flight time also increases beacause the result of the Power Consumption form for $t$ is directly influenced by the presence of $V$ in the denominator of its current draw estimation.

Finally the reduction of $I_{MAX}$ increases the resulting flight time since $I_{MAX}$ is multiplied into the denominator of the Current Draw form for $t$.

Carefully tuning these values within the constraints of the drone will maximise the flight time model, producing the best results for all batteries used.

## TODO
- pyinstaller - https://pyinstaller.readthedocs.io/en/stable/usage.html
- web version?
- support more battery retailer sites

Sources:

- https://youtu.be/g0HFGtzBtRs
- https://youtu.be/KLGfMGsgP34
